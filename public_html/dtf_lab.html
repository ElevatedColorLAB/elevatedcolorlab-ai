<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTF LAB Pro | ElevatedColorLab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- DTF LAB PRO / ELEVATED COLOR LAB SHARED STYLES --- */

        /* Base & Typography */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #f9fafb; /* Gray 50 */
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        /* Card Components */
        .card {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            border-radius: 0.75rem;
        }

        /* Scrollbars */
        .scroll-container {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #475569 #1e293b;
            min-height: 0;
        }
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: #1e293b; }
        .scroll-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .scroll-container::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Custom Scrollbars (General) */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Buttons & Interactive Elements */
        .btn-tool {
            background-color: #334155;
            color: #cbd5e1;
            border: 1px solid #475569;
            font-size: 0.75rem;
            padding: 0.6rem;
            width: 100%;
            justify-content: flex-start;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 0.25rem;
        }
        .btn-tool:hover {
            background-color: #475569;
            color: white;
            border-color: #64748b;
            transform: translateX(2px);
        }

        .rec-btn {
            margin-left: auto;
            background: #4f46e5; /* Indigo 600 */
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            cursor: pointer;
        }

        /* Navigation Tabs */
        .nav-tab {
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            opacity: 0.6;
        }
        .nav-tab.active {
            border-color: #6366f1; /* Indigo 500 */
            color: #fff;
            opacity: 1;
        }

        /* Form Inputs */
        .input-xs {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            width: 100%;
        }
        .input-xs:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Canvas & Viewport */
        .viewport-container {
            overflow: hidden;
            position: relative;
            background-color: #0f172a;
            height: 100%;
            width: 100%;
            cursor: grab;
            display: block;
        }
        .viewport-container:active { cursor: grabbing; }

        .hq-render {
            image-rendering: auto;
            image-rendering: -webkit-optimize-contrast;
            will-change: transform;
        }

        /* Gang Sheet Item (Draggable Wrapper) */
        .sheet-item {
            position: absolute;
            cursor: grab;
            transition: box-shadow 0.1s;
            margin: 0;
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-sizing: border-box;
        }
        .sheet-item:hover {
            box-shadow: 0 0 0 1px #38bdf8;
            z-index: 100;
        }
        .sheet-item:active { cursor: grabbing; }
        
        /* Overlap detection */
        .sheet-item.overlapping {
            box-shadow: 0 0 0 2px #ef4444 !important;
            animation: pulse-red 0.5s ease-in-out;
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 2px #ef4444; }
            50% { box-shadow: 0 0 0 4px #ef4444; }
        }

        /* Tight packing mode */
        .tight-packing .sheet-item {
            border: none !important;
            margin: 0 !important;
        }

        /* Background Patterns */
        .checkerboard {
            background-color: #334155;
            background-image: 
                linear-gradient(45deg, #475569 25%, transparent 25%), 
                linear-gradient(-45deg, #475569 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #475569 75%), 
                linear-gradient(-45deg, transparent 75%, #475569 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loader-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6366f1; /* Indigo 500 */
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Edge spacing visualization */
        .edge-spacing {
            position: absolute;
            background: rgba(239, 68, 68, 0.1);
            border: 1px dashed rgba(239, 68, 68, 0.3);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Grid overlay */
        .packing-grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <!-- Top Nav -->
    <nav class="bg-slate-900/95 border-b border-slate-700 z-50 h-16 flex-shrink-0">
        <div class="max-w-full mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-900/50">
                        <i class="fas fa-layer-group text-white"></i>
                    </div>
                    <span class="text-xl font-bold text-white tracking-tight">DTF LAB <span class="text-indigo-400 text-xs uppercase ml-1 align-top">Pro</span></span>
                </div>
                <div class="flex space-x-6 ml-8 h-full">
                    <button onclick="switchMode('editor')" id="tab-editor" class="nav-tab active h-full flex items-center gap-2 text-sm font-medium">
                        <i class="fas fa-pencil-alt"></i> Image Editor
                    </button>
                    <button onclick="switchMode('gangsheet')" id="tab-gangsheet" class="nav-tab h-full flex items-center gap-2 text-sm font-medium">
                        <i class="fas fa-scroll"></i> Gang Sheet Builder
                        <span id="queue-badge" class="bg-indigo-600 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- TOP COST DISPLAY -->
                <div id="top-cost-display" class="hidden items-center mr-4 bg-slate-800 px-3 py-1 rounded border border-slate-700 shadow-sm">
                    <span class="text-xs text-slate-400 mr-2 uppercase tracking-wider">Product Cost:</span>
                    <span id="top-total-cost" class="text-green-400 font-mono font-bold text-sm">$0.00</span>
                </div>

                <div class="flex items-center gap-2 text-xs bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700">
                    <span id="vps-dot" class="w-2 h-2 rounded-full bg-yellow-500"></span>
                    <span id="vps-status" class="text-slate-300">Connecting...</span>
                </div>
                <a href="https://elevatedcolorlab.com/dashboard.html" class="text-slate-400 hover:text-white text-sm font-medium"><i class="fas fa-sign-out-alt mr-1"></i> Exit</a>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden relative min-h-0">
        
        <!-- VIEW 1: IMAGE EDITOR -->
        <div id="view-editor" class="absolute inset-0 grid grid-cols-12 gap-0 h-full">
            <!-- Left Sidebar -->
            <div class="col-span-3 bg-slate-900 border-r border-slate-800 flex flex-col h-full overflow-hidden">
                <!-- Header (Fixed) -->
                <div class="p-4 border-b border-slate-800 shrink-0">
                    <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-2">Active Image</h3>
                    <div class="border-2 border-dashed border-slate-700 rounded-lg p-6 text-center hover:border-indigo-500 cursor-pointer transition-all bg-slate-800/50" onclick="document.getElementById('editor-upload').click()">
                        <input type="file" id="editor-upload" class="hidden" accept="image/*" onchange="loadEditorImage(this.files[0])">
                        <i class="fas fa-cloud-upload-alt text-3xl text-slate-500 mb-2"></i>
                        <p class="text-xs text-slate-400">Click to Upload</p>
                    </div>
                    
                    <!-- Image Properties -->
                    <div id="image-props" class="mt-4 hidden text-[10px] text-slate-400 space-y-2 bg-slate-950 p-3 rounded border border-slate-800">
                        <div class="flex justify-between items-center border-b border-slate-800 pb-2">
                            <span>Original (Px):</span> <span id="prop-orig" class="text-white font-mono">-</span>
                        </div>
                        <div class="pt-1">
                            <div class="flex justify-between mb-1"><span class="text-indigo-300 font-bold">Required Print Size:</span></div>
                            <div class="grid grid-cols-2 gap-2 items-center">
                                <div><label class="block text-[9px] mb-0.5">Width (in)</label><input type="number" id="target-width" class="input-xs w-full" step="0.1" onchange="updateTargetSize('w')"></div>
                                <div><label class="block text-[9px] mb-0.5">Height (in)</label><input type="number" id="target-height" class="input-xs w-full" step="0.1" onchange="updateTargetSize('h')"></div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-slate-800">
                            <span>Output DPI:</span> <span id="prop-dpi" class="text-white font-mono font-bold">300</span>
                        </div>
                    </div>
                </div>

                <!-- Scrolling Tools -->
                <div class="p-4 flex-1 scroll-container space-y-4 min-h-0">
                    <!-- Image Health -->
                    <div id="health-panel" class="hidden bg-slate-800/80 border border-slate-700 rounded p-3 fade-in mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xs font-bold text-white flex items-center gap-2"><i class="fas fa-stethoscope text-green-400"></i> Auto-Flight Check</h3>
                            <span class="text-[10px] bg-slate-700 px-1.5 rounded text-slate-300">Smart Scan</span>
                        </div>
                        <div id="health-content" class="space-y-2"></div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Enhancement</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="runTool('upscaler')" id="btn-upscale" class="btn-tool rounded"><i class="fas fa-expand text-indigo-400"></i> Upscale to Size</button>
                                <button onclick="runTool('vectorizer')" class="btn-tool rounded"><i class="fas fa-bezier-curve text-indigo-400"></i> Vectorize</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Correction</h3>
                            <div class="space-y-2">
                                <button onclick="runTool('bg_remover')" class="btn-tool rounded"><i class="fas fa-eraser text-red-400"></i> Remove Background</button>
                                <button onclick="runTool('knockout')" class="btn-tool rounded"><i class="fas fa-tshirt text-slate-200"></i> Knockout Black</button>
                                <button onclick="runTool('transparency')" class="btn-tool rounded"><i class="fas fa-ghost text-blue-400"></i> Fix Transparency</button>
                                <button onclick="runTool('crop')" class="btn-tool rounded"><i class="fas fa-crop-alt text-green-400"></i> Auto-Crop Bounds</button>
                            </div>
                        </div>
                        <!-- MOVED BUTTONS HERE -->
                        <div class="pt-4 border-t border-slate-700 space-y-2">
                            <button onclick="downloadCurrentImage()" id="btn-dl-img" class="w-full py-2 border border-slate-600 text-slate-300 hover:bg-slate-800 rounded text-xs font-bold flex items-center justify-center gap-2 disabled:opacity-50 mb-2" disabled><i class="fas fa-download"></i> Download Image</button>
                            <button onclick="addToGangSheet()" id="btn-add-gang" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm font-bold shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 transition-all" disabled><i class="fas fa-plus-circle"></i> Save & Add to Gang Sheet</button>
                        </div>
                    </div>
                    <div class="h-4"></div>
                </div>
            </div>

            <!-- Right: Canvas -->
            <div class="col-span-9 bg-slate-950 relative flex flex-col h-full">
                <div class="h-12 border-b border-slate-800 flex justify-between items-center px-4 bg-slate-900 shrink-0">
                    <div class="flex items-center gap-2">
                        <button onclick="editorUndo()" id="btn-undo" class="w-8 h-8 bg-slate-800 rounded text-slate-400 hover:text-white disabled:opacity-30 border border-slate-700" title="Undo" disabled><i class="fas fa-undo"></i></button>
                        <div class="h-6 w-px bg-slate-700 mx-1"></div>
                        <button onclick="zoomEditor(0.1)" class="w-8 h-8 bg-slate-800 rounded text-slate-400 hover:text-white"><i class="fas fa-plus"></i></button>
                        <span id="editor-zoom-display" class="text-xs text-slate-400 font-mono w-12 text-center">100%</span>
                        <button onclick="zoomEditor(-0.1)" class="w-8 h-8 bg-slate-800 rounded text-slate-400 hover:text-white"><i class="fas fa-minus"></i></button>
                        <button onclick="resetEditorZoom()" class="w-8 h-8 bg-slate-800 rounded text-slate-400 hover:text-white ml-2" title="Fit to Screen"><i class="fas fa-compress-arrows-alt"></i></button>
                    </div>
                    <span id="editor-status" class="text-xs text-indigo-400 hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Processing AI...</span>
                </div>
                <div id="editor-viewport" class="viewport-container flex items-center justify-center p-10 flex-1">
                    <div id="editor-pan-layer" class="relative shadow-2xl transition-transform duration-100 ease-out">
                        <img id="editor-img" src="" class="max-w-none hidden checkerboard hq-render" draggable="false">
                        <div id="editor-placeholder" class="text-slate-600 flex flex-col items-center">
                            <i class="fas fa-image text-6xl mb-4 opacity-20"></i>
                            <p>Upload an image to begin editing</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: GANG SHEET -->
        <div id="view-gangsheet" class="absolute inset-0 grid grid-cols-12 gap-0 h-full hidden">
            <!-- Left: Queue -->
            <div class="col-span-3 bg-slate-900 border-r border-slate-800 flex flex-col h-full overflow-hidden">
                <!-- Fixed Header -->
                <div class="p-4 border-b border-slate-800 shrink-0">
                    <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-3">Sheet Configuration</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-slate-400 block mb-1">Media Width</label>
                            <select id="gs-width" class="w-full bg-slate-800 border border-slate-700 text-white rounded text-xs p-1.5 focus:border-indigo-500 outline-none">
                                <optgroup label="Rolls">
                                    <option value="22">22" Roll</option>
                                    <option value="24">24" Roll</option>
                                    <option value="13">13" Roll</option>
                                </optgroup>
                                <optgroup label="Sheets">
                                    <option value="11.7|16.5">A3 Sheet</option>
                                    <option value="13|19">A3+ Sheet</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400 block mb-1">Length</label>
                            <select id="gs-length" class="w-full bg-slate-800 border border-slate-700 text-white rounded text-xs p-1.5 focus:border-indigo-500 outline-none">
                                <option value="auto">Auto-Calculate</option>
                                <option value="24">24" (2ft)</option>
                                <option value="60">60" (5ft)</option>
                                <option value="120">120" (10ft)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Roll Media Edge Spacing -->
                    <div id="roll-spacing-controls" class="mt-3 pt-3 border-t border-slate-800 hidden">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Roll Edge Spacing</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[9px] text-slate-500 mb-0.5">Left/Right (in)</label>
                                <input type="number" id="edge-horizontal" value="0.25" step="0.05" class="input-xs w-full" oninput="updateEdgeSpacing()">
                            </div>
                            <div>
                                <label class="block text-[9px] text-slate-500 mb-0.5">Top/Bottom (in)</label>
                                <input type="number" id="edge-vertical" value="0.5" step="0.05" class="input-xs w-full" oninput="updateEdgeSpacing()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Packing Options -->
                    <div class="mt-3 pt-3 border-t border-slate-800">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Packing Options</h3>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="tight-packing" class="w-3 h-3">
                            <label for="tight-packing" class="text-[10px] text-slate-300">Ultra-Tight Packing</label>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="allow-rotation" class="w-3 h-3" checked>
                            <label for="allow-rotation" class="text-[10px] text-slate-300">Allow Rotation</label>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="auto-arrange" class="w-3 h-3" checked>
                            <label for="auto-arrange" class="text-[10px] text-slate-300">Auto-Arrange on Overlap</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="aggressive-rotation" class="w-3 h-3">
                            <label for="aggressive-rotation" class="text-[10px] text-slate-300">Aggressive Rotation</label>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <input type="checkbox" id="show-grid" class="w-3 h-3">
                            <label for="show-grid" class="text-[10px] text-slate-300">Show Packing Grid</label>
                        </div>
                    </div>
                    
                    <!-- Pricing (Cost Only) -->
                    <div class="mt-3 pt-3 border-t border-slate-800">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Cost Calculator</h3>
                        <div>
                            <label class="block text-[9px] text-slate-500 mb-0.5">Cost / Sq In</label>
                            <div class="relative">
                                <span class="absolute left-1.5 top-0.5 text-slate-400 text-[10px]">$</span>
                                <input type="number" id="cost-input" value="0.025" step="0.001" class="input-xs w-full pl-3" oninput="updateCostCalc()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SCROLLING QUEUE -->
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="p-3 bg-slate-800/50 flex justify-between items-center shrink-0 p-2 rounded mb-2 mx-3 mt-3">
                        <h3 class="text-xs font-bold text-slate-300">Image Queue</h3>
                        <div class="flex items-center gap-2">
                            <input type="file" id="direct-upload" class="hidden" multiple accept="image/*" onchange="handleDirectUpload(this.files)">
                            <button onclick="document.getElementById('direct-upload').click()" class="bg-slate-700 hover:bg-slate-600 text-indigo-300 px-2 py-1 rounded text-[10px] font-bold border border-slate-600" title="Quick Add Images"><i class="fas fa-bolt mr-1"></i>Quick Add</button>
                            <span id="queue-count" class="text-[10px] text-slate-500">0 Items</span>
                        </div>
                    </div>
                    <div id="queue-list" class="flex-1 scroll-container p-3 space-y-2">
                        <div id="gs-empty-state" class="text-center text-slate-600 text-xs mt-10 flex flex-col items-center gap-3">
                            <p class="italic">Queue is empty.</p>
                            <p class="text-[10px] text-slate-500 max-w-[180px]">Use Quick Add for print-ready files (300 DPI).</p>
                        </div>
                    </div>
                </div>

                <!-- FOOTER (Fixed) -->
                <div class="p-4 border-t border-slate-800 bg-slate-900 z-10 shrink-0 mt-auto shadow-lg">
                    <button onclick="autoNest()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold text-sm shadow-lg mb-2 transition-all">
                        <i class="fas fa-th mr-2"></i> Auto-Nest Layout
                    </button>
                    <div class="flex justify-between text-xs text-slate-400 px-1">
                        <span>Height: <span id="total-height" class="text-white font-mono">0"</span></span>
                        <span>Efficiency: <span id="packing-efficiency" class="text-green-400 font-mono">0%</span></span>
                    </div>
                </div>
            </div>

            <!-- Right: Canvas -->
            <div class="col-span-9 bg-slate-950 relative flex flex-col h-full">
                <div class="h-12 border-b border-slate-800 flex justify-between items-center px-4 bg-slate-900 shrink-0">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <button onclick="zoomGS(0.1)" class="btn-icon text-slate-400 hover:text-white"><i class="fas fa-plus"></i></button>
                            <span id="gs-zoom-val" class="text-xs text-slate-400 font-mono w-10 text-center">Fit</span>
                            <button onclick="zoomGS(-0.1)" class="btn-icon text-slate-400 hover:text-white"><i class="fas fa-minus"></i></button>
                            <button onclick="fitGS()" class="btn-icon text-slate-400 hover:text-white ml-2"><i class="fas fa-expand"></i></button>
                        </div>
                        <div class="h-6 w-px bg-slate-700 mx-2"></div>
                        <div class="flex items-center gap-4 text-xs">
                            <div class="flex flex-col items-end leading-tight">
                                <span class="text-slate-400 text-[10px]">Product Cost</span>
                                <span id="total-price-top" class="text-green-400 font-mono font-bold text-sm">$0.00</span>
                            </div>
                            <div class="flex flex-col items-end leading-tight">
                                <span class="text-slate-400 text-[10px]">Wasted Area</span>
                                <span id="wasted-area" class="text-red-400 font-mono font-bold text-sm">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="detectAndFixOverlaps()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded text-xs font-bold border border-slate-600 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i> Fix Overlaps
                        </button>
                        <button onclick="exportFile()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded text-xs font-bold border border-slate-600 flex items-center gap-2">
                            <i class="fas fa-file-export text-green-400"></i> Export File
                        </button>
                    </div>
                </div>

                <div id="gs-viewport" class="viewport-container relative flex-1">
                    <div class="absolute top-4 left-1/2 -translate-x-1/2 bg-slate-800/90 text-slate-300 text-[10px] font-mono px-3 py-1 rounded-full border border-slate-600 shadow-lg z-20 pointer-events-none">
                        <i class="fas fa-ruler mr-1 text-indigo-400"></i> <span id="badge-w">22</span>" x <span id="badge-h">Auto</span>"
                        <span id="roll-indicator" class="ml-2 text-yellow-400 hidden"><i class="fas fa-roll"></i> Roll</span>
                    </div>
                    <div id="gs-pan-layer" class="absolute top-0 left-0">
                        <div id="gang-sheet" class="checkerboard relative transition-all duration-300"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Gemini Modal -->
    <div id="ai-modal" class="modal-overlay">
        <div class="bg-slate-800 w-full max-w-md rounded-xl border border-slate-600 shadow-2xl p-0 overflow-hidden">
            <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between">
                <h3 class="text-white font-bold flex items-center gap-2"><i class="fas fa-sparkles text-indigo-400"></i> AI Advisor</h3>
                <button onclick="document.getElementById('ai-modal').style.display='none'" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="ai-content" class="p-5 text-sm text-slate-300 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <script src="assets/js/dtf_lab.js"></script>
</body>
</html>